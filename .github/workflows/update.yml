name: 全自动更新+永久登录
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches: [ main ]
jobs:
  auto_update:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库文件
        uses: actions/checkout@v4
      - name: 创建必要目录
        run: mkdir -p binaries paycode plugins
      - name: 下载最新版go-cqhttp（amd64架构，适配GitHub Action）
        run: |
          # 获取最新版下载链接（自动适配amd64）
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/Mrs4s/go-cqhttp/releases/latest | grep browser_download_url | grep linux_amd64.tar.gz | cut -d '"' -f 4)
          # 下载并解压到binaries目录
          wget -q $DOWNLOAD_URL -O ./binaries/go-cqhttp.tar.gz
          tar -zxvf ./binaries/go-cqhttp.tar.gz -C ./binaries --strip-components=1
          # 删除压缩包
          rm -f ./binaries/go-cqhttp.tar.gz
          # 添加执行权限
          chmod +x ./binaries/go-cqhttp
      - name: 备份登录凭证（一次扫码永久生效）
        run: |
          cp -f ./binaries/config.yml ./binaries/config_bak.yml 2>/dev/null
          cp -f ./binaries/device.json ./binaries/device_bak.json 2>/dev/null
          cp -f ./binaries/session.token ./binaries/session_bak.token 2>/dev/null
      - name: 恢复登录凭证
        run: |
          cp -f ./binaries/config_bak.yml ./binaries/config.yml 2>/dev/null
          cp -f ./binaries/device.json ./binaries/device.json 2>/dev/null
          cp -f ./binaries/session_bak.token ./binaries/session.token 2>/dev/null
          rm -rf ./binaries/*_bak.*
      - name: 同步仓库所有文件
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Bot"
          git add ./binaries/* ./paycode/* ./plugins/* ./main.py
          git commit -m "自动更新go-cqhttp+同步功能文件" -a || echo "无需更新"
          git push origin main
