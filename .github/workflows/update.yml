name: 红米专属-全自动下载安装运行机器人
on:
  workflow_dispatch:
  push:
    branches: [ main ]
jobs:
  auto_install:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库所有文件
        uses: actions/checkout@v4
        
      - name: 自动创建所有需要的文件夹
        run: mkdir -p binaries plugins
        
      - name: ✅ 红米ARM64版go-cqhttp下载+校验+解压+赋权
        run: |
          cd binaries
          # 下载ARM64包（带进度+备用链接）
          echo "下载红米专属ARM64版go-cqhttp..."
          wget --show-progress https://github.com/Mrs4s/go-cqhttp/releases/latest/download/go-cqhttp_linux_arm64.tar.gz -O gocq.tar.gz || { echo "用备用链接下载"; wget --show-progress https://github.com/Mrs4s/go-cqhttp/releases/download/v1.2.0/go-cqhttp_linux_arm64.tar.gz -O gocq.tar.gz; }
          # 校验压缩包
          if [ ! -f "gocq.tar.gz" ]; then echo "❌ 压缩包下载失败"; exit 1; fi
          # 解压
          tar -zxvf gocq.tar.gz -C . --overwrite || { echo "解压重试"; tar -zxvf gocq.tar.gz -C . --overwrite --ignore-zeros; }
          # 检查可执行文件
          if [ ! -f "go-cqhttp" ]; then echo "❌ 未找到go-cqhttp"; exit 1; fi
          # 清理+赋权
          rm -rf gocq.tar.gz LICENSE README.md
          chmod 777 go-cqhttp
          echo "✅ go-cqhttp配置完成"
          
      - name: ✅ 自动备份登录凭证（容错版，无文件则跳过）
        run: |
          cd binaries
          # 仅当文件存在时才备份，避免报错
          if [ -f "config.yml" ]; then cp -f config.yml config_bak.yml; echo "备份config.yml"; fi
          if [ -f "device.json" ]; then cp -f device.json device_bak.json; echo "备份device.json"; fi
          if [ -f "session.token" ]; then cp -f session.token session_bak.token; echo "备份session.token"; fi
          # 仅当备份文件存在时才恢复，避免报错
          if [ -f "config_bak.yml" ]; then cp -f config_bak.yml config.yml; echo "恢复config.yml"; fi
          if [ -f "device_bak.json" ]; then cp -f device_bak.json device.json; echo "恢复device.json"; fi
          if [ -f "session_bak.token" ]; then cp -f session_bak.token session.token; echo "恢复session.token"; fi
          echo "✅ 凭证备份/恢复完成（无文件则跳过）"
          
      - name: ✅ 自动同步所有文件到仓库
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Bot"
          git add binaries/* plugins/* main.py
          git commit -m "红米全自动配置完成" -a || echo "无需更新"
          git push origin main
