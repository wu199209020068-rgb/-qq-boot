name: 红米专属-全自动下载安装运行机器人
on:
  workflow_dispatch:
  push:
    branches: [ main ]
jobs:
  auto_install:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库所有文件
        uses: actions/checkout@v4
        
      - name: 自动创建所有需要的文件夹
        run: mkdir -p binaries plugins
        
      - name: ✅ 全自动下载红米ARM64版go-cqhttp+解压+赋权 一步到位
        run: |
          cd binaries
          # 红米专属ARM64下载链接，永久有效，不会失效
          wget -q https://github.com/Mrs4s/go-cqhttp/releases/latest/download/go-cqhttp_linux_arm64.tar.gz -O gocq.tar.gz
          # 强制解压，只保留运行文件，删垃圾
          tar -zxvf gocq.tar.gz --strip-components=1
          rm -rf gocq.tar.gz LICENSE README.md
          # 强制给足运行权限，红米手机必用
          chmod 777 go-cqhttp
          echo "✅ 红米专用go-cqhttp下载+解压+权限配置完成"
          
      - name: ✅ 自动备份登录凭证 一次扫码永久登录
        run: |
          cd binaries
          cp -f config.yml config_bak.yml 2>/dev/null
          cp -f device.json device_bak.json 2>/dev/null
          cp -f session.token session_bak.token 2>/dev/null
          cp -f config_bak.yml config.yml 2>/dev/null
          cp -f device_bak.json device.json 2>/dev/null
          cp -f session_bak.token session.token 2>/dev/null
          
      - name: ✅ 自动同步所有文件到仓库
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Bot"
          git add binaries/* plugins/* main.py
          git commit -m "红米全自动配置完成" -a || echo "无需更新"
          git push origin main
